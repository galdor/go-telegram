#!/usr/bin/env ruby

require "net/http"
require "nokogiri"
require "uri"
require "time"

class Scrapper
  def initialize(uri)
    @uri = URI.parse(uri)
    @doc = nil
    @types = nil
  end

  def fetch()
    data = Net::HTTP.get(@uri)
    @doc = Nokogiri::HTML5.parse(data)
  end

  def extract_types()
    fetch() unless @doc

    types = {}

    titles = @doc.css("h4")

    titles.each() do |title|
      description_paragraph = title.next_element()
      next unless description_paragraph.name() == "p"

      table = description_paragraph.next_element()
      # Types which do not contain fields do not have a table element

      type_name = title.text()
      next unless type_name.match /^[A-Za-z]+$/
      next unless type_name[0] >= 'A' && type_name[0] <= 'Z'

      description = description_paragraph.text()

      fields = []

      if table
        table.css("tbody > tr").each do |row|
          cells = row.css("td")
          if cells.length != 3
            raise "type row #{row} does not have three cells"
          end

          field_name = cells[0].text()
          field_type = cells[1].text()
          field_description = cells[2].text()

          optional = cells[2].at_css("em")&.text() == "Optional"

          fields << {
            name: field_name,
            type: field_type,
            optional: optional,
            description: field_description,
          }
        end
      end

      types[type_name] = {
        name: type_name,
        description: description,
        fields: fields,
      }
    end

    @types = types
  end

  def generate_go_types(package_name: "main")
    extract_types() unless @types

    now = Time.now().utc()

    buf = StringIO.new()

    buf << "// File generated by #{$0} at #{now.iso8601()}\n"
    buf << "// using data from #{@uri}.\n\n"
    buf << "package #{package_name}\n"

    buf << "import \"encoding/json\""

    @types.each() do |name, type|
      buf << "\n// #{type[:description]}\n"
      buf << "type #{type[:name]} struct {\n"

      type[:fields].each() do |field|
        name = snake_case_to_pascal_case(field[:name])
        type = go_type(field[:type], field[:name])

        json_tag = field[:name]
        json_tag += ",omitempty" if field[:optional]

        buf << name
        buf << " "
        if type
          buf << type
        else
          buf << "json.RawMessage"
        end
        buf << " `json:\"#{json_tag}\"`"
        if !type
          buf << " // "
          buf << field[:type]
        end
        buf << "\n"
      end

      buf << "}\n"
    end

    IO.popen(["gofmt"], "r+") do |io|
      io.write(buf.string())
      io.close_write()
      puts io.read()
    end
  end

  def snake_case_to_pascal_case(string)
    return string.split("_").map do |word|
      case word
      when "mime"
        "MIME"
      when "url"
        "URL"
      else
        word.capitalize()
      end
    end.join
  end

  def go_type(type_string, field_name)
    case type_string
    when "String"
      "string"
    when "Boolean", "True"
      "bool"
    when "Integer"
      if field_name == "id" || field_name.match(/_id$/)
        "int64"
      else
        "int"
      end
    when "Float", "Float number"
      "float64"
    when /^Array of (.*)$/
      "[]" + go_type($1, field_name)
    when "Integer or String"
      "Integer"
    when /^([^ ]+) or ([^ ]+)$/
      nil
    when /^[A-Za-z]+$/
      "*"+type_string
    else
      raise "invalid type \"#{type_string}\""
    end
  end
end

scrapper = Scrapper.new("https://core.telegram.org/bots/api")
print scrapper.generate_go_types(package_name: "bot")
